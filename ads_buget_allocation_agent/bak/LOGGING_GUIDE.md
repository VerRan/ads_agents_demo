# ğŸ“ é¢„ç®—åˆ†é…Agentæ—¥å¿—è®°å½•æŒ‡å—

## ğŸ¯ æ¦‚è¿°

ç°åœ¨ä½ å¯ä»¥å°†`PrintingCallbackHandler`çš„æ‰€æœ‰è¾“å‡ºä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶ä¿æŒåœ¨ç»ˆç«¯çš„å®æ—¶æ˜¾ç¤ºã€‚**é‡è¦æ›´æ–°**ï¼šæˆ‘ä»¬å·²ç»å®Œç¾è§£å†³äº†Pythonä»£ç æ‰§è¡Œç»“æœçš„æ•è·é—®é¢˜ï¼Œç°åœ¨ç»ˆç«¯è¾“å‡ºå’Œæ–‡ä»¶è®°å½•å®Œå…¨ä¸€è‡´ï¼

## ğŸ”§ å¤šç§æ—¥å¿—æ¨¡å¼

### 1. ç®€å•æ–‡ä»¶è®°å½• (`simple`)
- **ç‰¹ç‚¹**: åªå°†å…³é”®ä¿¡æ¯å†™å…¥æ–‡ä»¶
- **é€‚ç”¨**: éœ€è¦ç®€æ´æ—¥å¿—è®°å½•çš„åœºæ™¯
- **è¾“å‡º**: æ–‡ä»¶è®°å½• + å¯é€‰ç»ˆç«¯æ˜¾ç¤º

### 2. åŒè¾“å‡ºæ¨¡å¼ (`dual`)
- **ç‰¹ç‚¹**: å®Œå…¨ä¿æŒåŸæœ‰çš„ç»ˆç«¯è¾“å‡ºï¼ŒåŒæ—¶å†™å…¥æ–‡ä»¶
- **é€‚ç”¨**: æ—¢è¦å®æ—¶æŸ¥çœ‹åˆè¦ä¿å­˜æ—¥å¿—
- **è¾“å‡º**: ç»ˆç«¯æ˜¾ç¤º + å®Œæ•´æ–‡ä»¶è®°å½•

### 3. å®Œæ•´æ•è·æ¨¡å¼ (`complete`) â­ **å¼ºçƒˆæ¨è**
- **ç‰¹ç‚¹**: å®Œç¾æ•è·æ‰€æœ‰Pythonæ‰§è¡Œç»“æœï¼ŒåŒ…æ‹¬æ•°æ®æ¡†ã€ç»Ÿè®¡ä¿¡æ¯ã€å›¾è¡¨ç­‰
- **é€‚ç”¨**: éœ€è¦å®Œæ•´è®°å½•æ•°æ®åˆ†æè¿‡ç¨‹çš„åœºæ™¯
- **è¾“å‡º**: ç»ˆç«¯æ˜¾ç¤º + **å®Œæ•´Pythonæ‰§è¡Œç»“æœ** + ç»“æ„åŒ–æ–‡ä»¶è®°å½•
- **æ ¼å¼**: ä½¿ç”¨å›¾æ ‡æ ‡è¯†ï¼ˆğŸ”§å·¥å…·è°ƒç”¨ ğŸ¤–Agentå›å¤ ğŸ“ŠPythonæ‰§è¡Œç»“æœï¼‰

### 4. ç»“æ„åŒ–æ—¥å¿— (`structured`)
- **ç‰¹ç‚¹**: è¯¦ç»†çš„æ­¥éª¤åŒ–æ—¥å¿—ï¼Œå¸¦æ—¶é—´æˆ³å’Œæ­¥éª¤ç¼–å·
- **é€‚ç”¨**: éœ€è¦è¯¦ç»†åˆ†ææ‰§è¡Œè¿‡ç¨‹çš„åœºæ™¯
- **è¾“å‡º**: ç»“æ„åŒ–æ–‡ä»¶ + å¯é€‰ç»ˆç«¯æ‘˜è¦

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ä¿®æ”¹ç°æœ‰ä»£ç  (æœ€ç®€å•)

åœ¨ä½ çš„`buget_allocation_agent.py`ä¸­ï¼Œç°åœ¨å·²ç»æ›´æ–°ä¸ºï¼š

```python
from custom_callback_handler import create_callback_handler

# åˆ›å»ºè‡ªå®šä¹‰å›è°ƒå¤„ç†å™¨ - å®Œç¾æ•è·Pythonæ‰§è¡Œç»“æœ
callback_handler = create_callback_handler(
    handler_type="complete",  # å¼ºçƒˆæ¨èï¼šå®Œæ•´æ•è·æ‰€æœ‰è¾“å‡º
    log_file=None,  # è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶å
)

agent = Agent(
    model=get_llm(),
    system_prompt=PROMPT,
    tools=[file_read, python_repl],
    callback_handler=callback_handler
)
```

### æ–¹æ³•2: ä½¿ç”¨ä¸“é—¨çš„è¿è¡Œè„šæœ¬

```bash
# è¿è¡Œå¸¦æ—¥å¿—è®°å½•çš„åˆ†æ
python run_with_logging.py

# æˆ–è€…ç›´æ¥è¿è¡Œä¸»ç¨‹åº
python buget_allocation_agent.py
```

### æ–¹æ³•3: è‡ªå®šä¹‰é…ç½®

```python
# è‡ªå®šä¹‰æ—¥å¿—æ–‡ä»¶å - å®Œæ•´æ¨¡å¼
callback_handler = create_callback_handler(
    handler_type="complete",
    log_file="my_budget_analysis_2024.log"
)

# åªè®°å½•åˆ°æ–‡ä»¶ï¼Œä¸åœ¨ç»ˆç«¯æ˜¾ç¤º
callback_handler = create_callback_handler(
    handler_type="simple",
    also_print=False
)

# æµ‹è¯•ç®€å•åœºæ™¯
callback_handler = create_callback_handler(
    handler_type="complete",
    log_file="simple_test.log"
)
```

## ğŸ“ æ—¥å¿—æ–‡ä»¶æ ¼å¼

### è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶åæ ¼å¼:
- `budget_analysis_complete_20250703_145634.txt` (completeæ¨¡å¼) â­ **æ¨è**
- `budget_analysis_log_20240101_143022.txt` (dualæ¨¡å¼)
- `budget_analysis_detailed_20240101_143022.txt` (structuredæ¨¡å¼)

### æ—¥å¿—å†…å®¹ç¤ºä¾‹ (completeæ¨¡å¼):

```
=== é¢„ç®—åˆ†é…Agentå®Œæ•´æ‰§è¡Œæ—¥å¿— ===
å¼€å§‹æ—¶é—´: 2025-07-03 14:56:34
==================================================

[14:56:38] ğŸ”§ å·¥å…· #1: file_read
----------------------------------------

[14:56:40] ğŸ¤– Agentå›å¤:
----------------------------------------
æˆ‘ä¼šå¸®æ‚¨åˆ†æå¹¿å‘Šæ•°æ®å¹¶ç»™å‡ºé¢„ç®—è°ƒæ•´å»ºè®®ã€‚é¦–å…ˆï¼Œè®©æˆ‘æŸ¥çœ‹æ‚¨æä¾›çš„æ•°æ®æ–‡ä»¶ã€‚
========================================

[14:56:40] ğŸ“Š Pythonæ‰§è¡Œç»“æœ:
----------------------------------------
Content of 2025-03-04_input.csv:
adset_id,campaign_id,daily_budget,purchase,ctr,roas...
adse_1835,camp_4441,51.1,3.0,0.0,41.8,48.5,1.3...
========================================

[14:56:43] ğŸ”§ å·¥å…· #2: python_repl
----------------------------------------

[14:56:47] ğŸ“Š Pythonæ‰§è¡Œç»“æœ:
----------------------------------------
æ•°æ®å½¢çŠ¶: (18, 22)

æ•°æ®åˆ—å: ['adset_id', 'campaign_id', 'daily_budget', 'purchase'...]

æ•°æ®å‰å‡ è¡Œ:
    adset_id campaign_id  ...  add_to_cart  cost_per_add_to_cart
0  adse_1835   camp_4441  ...          6.0                   8.5
1  adse_4014   camp_0057  ...         -1.0                  -1.0
...

æŒ‰Campaignåˆ†ç»„çš„æ•°æ®:
   campaign_id  daily_budget  purchase  purchase_value       roas
0    camp_0057           0.0      -1.0            -1.0  -1.000000
1    camp_0296          24.5       2.0          1220.0  48.900000
...

é¢„ç®—è°ƒæ•´å»ºè®®:
| Campaign ID | å½“å‰é¢„ç®— | å½“å‰ROAS | è°ƒæ•´åé¢„ç®— | è°ƒæ•´é‡‘é¢ | è°ƒæ•´å¹…åº¦ |
| ----------- | -------- | -------- | ---------- | -------- | -------- |
| camp_0296   | $24.5    | 48.9     | $35.87     | $11.37   | 46.39%   |
...
========================================

[14:58:25] ğŸ¤– Agentå›å¤:
----------------------------------------
# å¹¿å‘Šé¢„ç®—è°ƒæ•´å»ºè®®

æ ¹æ®æ‚¨æä¾›çš„å¹¿å‘Šæ•°æ®ï¼Œæˆ‘å·²å®Œæˆå¯¹2025-03-04æ•°æ®çš„åˆ†æ...
========================================
```

## ğŸ¯ å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: æ—¥å¸¸åˆ†æ (æ¨ècompleteæ¨¡å¼) â­
```python
# å®Œæ•´æ•è·æ‰€æœ‰Pythonæ‰§è¡Œç»“æœï¼ŒåŒ…æ‹¬æ•°æ®æ¡†å’Œç»Ÿè®¡ä¿¡æ¯
callback_handler = create_callback_handler("complete")
```

### åœºæ™¯2: æ‰¹é‡å¤„ç† (æ¨èsimpleæ¨¡å¼)
```python
# å‡å°‘ç»ˆç«¯è¾“å‡ºï¼Œä¸“æ³¨äºæ–‡ä»¶è®°å½•
callback_handler = create_callback_handler("simple", also_print=False)
```

### åœºæ™¯3: è°ƒè¯•åˆ†æ (æ¨èstructuredæ¨¡å¼)
```python
# è¯¦ç»†çš„æ­¥éª¤è®°å½•ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
callback_handler = create_callback_handler("structured")
```

### åœºæ™¯4: å¿«é€Ÿæµ‹è¯•
```python
# ä½¿ç”¨ç®€å•æµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
python simple_test.py
```

## ğŸ“Š æ—¥å¿—æ–‡ä»¶çš„ä»·å€¼

### 1. å®Œæ•´çš„åˆ†æè¿‡ç¨‹è¿½æº¯ â­ **æ–°åŠŸèƒ½**
- å®Œæ•´è®°å½•AIçš„æ€è€ƒè¿‡ç¨‹
- **å®Œæ•´çš„Pythonä»£ç æ‰§è¡Œç»“æœ**ï¼ˆæ•°æ®æ¡†ã€ç»Ÿè®¡ä¿¡æ¯ã€å›¾è¡¨ï¼‰
- å·¥å…·è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯
- æ•°æ®å¤„ç†çš„æ¯ä¸ªæ­¥éª¤

### 2. ç»“æœéªŒè¯
- å¯¹æ¯”ä¸åŒå‚æ•°ä¸‹çš„åˆ†æç»“æœ
- éªŒè¯é¢„ç®—è°ƒæ•´å»ºè®®çš„åˆç†æ€§
- è¿½è¸ªä¼˜åŒ–æ•ˆæœ
- **æŸ¥çœ‹å®Œæ•´çš„æ•°æ®åˆ†æè¡¨æ ¼å’Œç»Ÿè®¡ä¿¡æ¯**

### 3. é—®é¢˜æ’æŸ¥
- å½“åˆ†æå‡ºç°å¼‚å¸¸æ—¶ï¼Œå¯ä»¥æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- äº†è§£åœ¨å“ªä¸ªæ­¥éª¤å‡ºç°äº†é—®é¢˜
- ä¼˜åŒ–promptå’Œå‚æ•°è®¾ç½®
- **æ£€æŸ¥Pythonä»£ç æ‰§è¡Œçš„å…·ä½“è¾“å‡º**

### 4. æŠ¥å‘Šç”Ÿæˆ
- åŸºäºæ—¥å¿—ç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Š
- å‘å®¢æˆ·å±•ç¤ºåˆ†æçš„ä¸“ä¸šæ€§å’Œé€æ˜åº¦
- ä½œä¸ºå†³ç­–ä¾æ®çš„æ”¯æ’‘ææ–™
- **åŒ…å«å®Œæ•´çš„æ•°æ®åˆ†æç»“æœå’Œå¯è§†åŒ–å†…å®¹**

## ğŸ†• æœ€æ–°åŠŸèƒ½ç‰¹æ€§

### âœ… å®Œç¾è§£å†³çš„é—®é¢˜
1. **Pythonæ‰§è¡Œç»“æœå®Œæ•´æ•è·** - ç°åœ¨å¯ä»¥å®Œæ•´è®°å½•æ‰€æœ‰printè¾“å‡ºã€æ•°æ®æ¡†æ˜¾ç¤ºã€ç»Ÿè®¡ä¿¡æ¯ç­‰
2. **ç»ˆç«¯å’Œæ–‡ä»¶è¾“å‡ºä¸€è‡´** - è§£å†³äº†ä¹‹å‰ç»ˆç«¯æœ‰å†…å®¹ä½†æ–‡ä»¶ç¼ºå¤±çš„é—®é¢˜
3. **ç»“æ„åŒ–æ—¥å¿—æ ¼å¼** - ä½¿ç”¨å›¾æ ‡å’Œæ¸…æ™°çš„åˆ†éš”ç¬¦ï¼Œä¾¿äºé˜…è¯»å’Œåˆ†æ
4. **æµå¼æ•°æ®å¤„ç†** - æ­£ç¡®å¤„ç†Strandsæ¡†æ¶çš„æµå¼å›è°ƒæœºåˆ¶

### ğŸ¯ æ ¸å¿ƒæ”¹è¿›
- **CompleteDualCallbackHandler**: æ–°çš„å›è°ƒå¤„ç†å™¨ï¼Œå®Œç¾æ•è·æ‰€æœ‰è¾“å‡º
- **æ™ºèƒ½æ•°æ®è§£æ**: æ­£ç¡®è§£æå·¥å…·ç»“æœä¸­çš„Pythonæ‰§è¡Œè¾“å‡º
- **æ¸…æ´çš„æ—¥å¿—æ ¼å¼**: ç§»é™¤è°ƒè¯•ä¿¡æ¯ï¼Œä¿æŒæ—¥å¿—æ–‡ä»¶æ•´æ´
- **è‡ªåŠ¨æ–‡ä»¶ç®¡ç†**: è‡ªåŠ¨ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ—¥å¿—æ–‡ä»¶å

## ğŸ”§ é«˜çº§é…ç½®

### æµ‹è¯•å’ŒéªŒè¯
```bash
# è¿è¡Œç®€å•æµ‹è¯•éªŒè¯åŠŸèƒ½
python simple_test.py

# è¿è¡Œå®Œæ•´çš„é¢„ç®—åˆ†æ
python buget_allocation_agent.py

# æ£€æŸ¥ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶
ls -la *.log *.txt
```

### è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
```python
class MyCustomHandler:
    def __init__(self, log_file):
        self.log_file = log_file
    
    def __call__(self, **kwargs):
        # è‡ªå®šä¹‰å¤„ç†é€»è¾‘
        with open(self.log_file, 'a') as f:
            f.write(f"Custom log: {kwargs}\n")

# ä½¿ç”¨è‡ªå®šä¹‰å¤„ç†å™¨
agent = Agent(
    model=get_llm(),
    system_prompt=PROMPT,
    tools=[file_read, python_repl],
    callback_handler=MyCustomHandler("custom.log")
)
```

### æ—¥å¿—è½®è½¬å’Œç®¡ç†
```python
import os
from datetime import datetime, timedelta

def cleanup_old_logs(log_dir=".", days_to_keep=7):
    """æ¸…ç†è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ—¥å¿—æ–‡ä»¶"""
    cutoff_date = datetime.now() - timedelta(days=days_to_keep)
    
    for filename in os.listdir(log_dir):
        if filename.startswith("budget_analysis_"):
            file_path = os.path.join(log_dir, filename)
            file_time = datetime.fromtimestamp(os.path.getctime(file_path))
            
            if file_time < cutoff_date:
                os.remove(file_path)
                print(f"åˆ é™¤æ—§æ—¥å¿—æ–‡ä»¶: {filename}")
```

## ğŸ‰ æ€»ç»“

ç°åœ¨ä½ å¯ä»¥ï¼š

1. âœ… **ä¿æŒåŸæœ‰ä½“éªŒ**: ç»ˆç«¯è¾“å‡ºå®Œå…¨ä¸å˜
2. âœ… **å®Œæ•´Pythonç»“æœæ•è·**: æ‰€æœ‰æ•°æ®æ¡†ã€ç»Ÿè®¡ä¿¡æ¯ã€å›¾è¡¨éƒ½è¢«å®Œæ•´è®°å½• â­ **æ–°åŠŸèƒ½**
3. âœ… **è‡ªåŠ¨ä¿å­˜æ—¥å¿—**: æ‰€æœ‰è¾“å‡ºè‡ªåŠ¨å†™å…¥æ–‡ä»¶
4. âœ… **çµæ´»é…ç½®**: å¤šç§æ¨¡å¼é€‚åº”ä¸åŒéœ€æ±‚
5. âœ… **ä¾¿äºåˆ†æ**: ç»“æ„åŒ–çš„æ—¥å¿—ä¾¿äºåç»­åˆ†æ
6. âœ… **é—®é¢˜æ’æŸ¥**: è¯¦ç»†è®°å½•ä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–
7. âœ… **ä¸“ä¸šæ ¼å¼**: ä½¿ç”¨å›¾æ ‡å’Œæ¸…æ™°åˆ†éš”ç¬¦çš„ä¸“ä¸šæ—¥å¿—æ ¼å¼

**å¼ºçƒˆæ¨èä½¿ç”¨completeæ¨¡å¼**ï¼Œå®ƒèƒ½å®Œç¾æ•è·æ‰€æœ‰Pythonæ‰§è¡Œç»“æœï¼Œè®©ä½ çš„æ•°æ®åˆ†æè¿‡ç¨‹å®Œå…¨é€æ˜å’Œå¯è¿½æº¯ï¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. è¿è¡Œé¢„ç®—åˆ†æï¼ˆè‡ªåŠ¨ä½¿ç”¨completeæ¨¡å¼ï¼‰
python buget_allocation_agent.py

# 2. æŸ¥çœ‹ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶
ls -la budget_analysis_complete_*.txt

# 3. è¿è¡Œç®€å•æµ‹è¯•éªŒè¯åŠŸèƒ½
python simple_test.py
```

ç°åœ¨ä½ çš„é¢„ç®—åˆ†é…Agentä¸ä»…èƒ½æä¾›ä¸“ä¸šçš„åˆ†æå»ºè®®ï¼Œè¿˜èƒ½å®Œæ•´è®°å½•æ•´ä¸ªåˆ†æè¿‡ç¨‹ï¼ğŸ‰